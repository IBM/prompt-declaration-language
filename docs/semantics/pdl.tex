\documentclass{article}
\usepackage[utf8]{inputenc}
\usepackage{mathpartir}


\title{PDL: Prompt Description Language}
\author{Martin Hirzel \and Louis Mandel \and Mandana Vaziri}


\begin{document}
\maketitle

\section{Semantics}

% Language

\renewcommand{\mit}[1]{\mathit{#1}}
\newcommand{\mtt}[1]{\texttt{#1}}

% \newcommand{\True}{\mit{tt}}
% \newcommand{\False}{\mit{ff}}
% \newcommand{\pdldef}[2]{#1 \texttt{:} {#2} }
% \newcommand{\pdlblock}[3][\True]{#2 ~\texttt{=}^{#1}~ #3 }
% \newcommand{\pdlmodel}[2]{\ensuremath{\mtt{model}({#1},{#2})}}
% \newcommand{\pdlcode}[1]{\ensuremath{\mtt{code}({#1})}}
% \newcommand{\pdlapi}[3]{\ensuremath{\mtt{api}({#1}, {#2},{#3})}}
% \newcommand{\pdlget}[1]{\ensuremath{\mtt{get}({#1})}}
% \newcommand{\pdlvalue}[1]{\ensuremath{\mtt{value}({#1})}}
% \newcommand{\pdlvaluep}[2]{\ensuremath{\mtt{value}({#1}, {#2})}}
% \newcommand{\pdlsequence}[2]{\ensuremath{\mtt{prompts}({#1},{#2})}}
% \newcommand{\pdlif}[2]{\ensuremath{\mtt{if}({#1},{#2})}}
% \newcommand{\pdlrepeats}[2]{\ensuremath{\mtt{repeats}({#1},{#2})}}
% \newcommand{\pdlrepeatsuntil}[2]{\ensuremath{\mtt{repeats\_until}({#1},{#2})}}
% \newcommand{\pdlinput}[1]{\ensuremath{\mtt{input}({#1})}}
% \newcommand{\pdlfunction}[2]{\ensuremath{\mtt{function}({#1}) \rightarrow {#2}}}
% \newcommand{\pdlclosure}[3]{\ensuremath{<\mtt{function}({#1}) \rightarrow {#2}, {#3}>}}
% \newcommand{\pdlcall}[2]{\ensuremath{\mtt{call}({#1}, {#2})}}
% \newcommand{\pdlreturns}[2]{\ensuremath{\mtt{returns}({#1}, {#2})}}


\newcommand{\True}{\mit{tt}}
\newcommand{\False}{\mit{ff}}

\newcommand{\jsnull}{\ensuremath{\mtt{null}}}
\newcommand{\jsstr}[1]{\ensuremath{\texttt{"}{#1}\texttt{"}}}
\newcommand{\jsobj}[1]{\ensuremath{\texttt{\{}{#1}\texttt{\}}}}
\newcommand{\jsarr}[1]{\ensuremath{\texttt{[}{#1}\texttt{]}}}


\newcommand{\pdldef}[2]{#1 \texttt{:} {#2} }
\newcommand{\pdlblockstar}[3][\True]{\mtt{def:}{#2}\mtt{,} \mtt{show:}{#1}\mtt{,} {#3} }
\newcommand{\pdlblock}[3][\True]{\jsobj{\pdlblockstar[#1]{#2}{#3}}}
\newcommand{\pdlblockdefs}[2]{\jsobj{\mtt{defs:}{#1}\mtt{,} {#2} }}
\newcommand{\pdlmodel}[2]{\ensuremath{\jsobj{\mtt{model:}{#1}\mtt{,}\mtt{input:}{#2}}}}
\newcommand{\pdlcode}[1]{\ensuremath{\jsobj{\mtt{code:}{#1}}}}
\newcommand{\pdlapi}[3]{\ensuremath{\jsobj{\mtt{url:}{#1}\mtt{,} \mtt{api:}{#2}\mtt{,} \mtt{input:}{#3}}}}
\newcommand{\pdlget}[1]{\ensuremath{\jsobj{\mtt{get:}{#1}}}}
\newcommand{\pdlvalue}[1]{\ensuremath{\jsobj{\mtt{value:}{#1}}}}
\newcommand{\pdlvaluep}[2]{\ensuremath{\jsobj{\mtt{value:}{#1}\mtt{,} \mtt{output:}{#2}}}}
\newcommand{\pdlsequence}[1]{\ensuremath{\jsobj{\mtt{prompts:}{#1}}}}
\newcommand{\pdlif}[2]{\ensuremath{\jsobj{\mtt{prompts:}{#1}\mtt{,} \mtt{if:}{#2}}}}
\newcommand{\pdlrepeats}[2]{\ensuremath{\jsobj{\mtt{prompts:}{#1}\mtt{,} \mtt{repeats:}{#2}}}}
\newcommand{\pdlrepeatsuntil}[2]{\ensuremath{\jsobj{\mtt{prompts:}{#1}\mtt{,} \mtt{repeats\_until:}{#2}}}}
\newcommand{\pdlinput}[1]{\ensuremath{\jsobj{\mtt{input:}{#1}}}}
\newcommand{\pdlfunction}[2]{\ensuremath{\jsobj{\mtt{function:}{#1}\mtt{,}  {#2}}}}
\newcommand{\pdlclosure}[3]{\ensuremath{\jsobj{\mtt{function:}{#1}\mtt{,}  {#2}, \mtt{scope:}{#3}}}}
\newcommand{\pdlcall}[2]{\ensuremath{\jsobj{\mtt{call:}{#1}\mtt{,} \mtt{args:}{#2}}}}



% Semantics

\newcommand{\pdlsemp}[5]{\ensuremath{{#1}, {#2} \Rightarrow {#3}, {#4}, {#5}}}
\newcommand{\pdlsembb}[5]{\ensuremath{{#1}, {#2} \rightarrow {#3}, {#4}, {#5}}}
\newcommand{\pdlsemc}[3]{\ensuremath{{#1}, {#2} \downarrow {#3}}}

\newcommand{\pdlstr}[1]{\ensuremath{\mit{str}({#1})}}


Language:
$$
\begin{array}{lcl}
    \mit{prompt} & ::= &\ 
        \mit{string}
        \mid \mit{block}
    \\
    \mit{prompts} & ::= &\ 
        \jsarr{\mit{prompt}\mtt{,} \dots\mtt{,} \mit{prompt}}
    \\
    \mit{block} & ::= &\
    \pdlblock[\mit{show}]{x}{\mit{block\_body}}
    \\ &&\mid
    \pdlblockdefs{\mit{defs}}{\pdlblockstar[\mit{show}]{x}{\mit{block\_body}}}
    \\
    \mit{defs} & ::= &\
    \jsobj{\pdldef{x}{\mit{block\_body}}\mtt{,} \dots\mtt{,}\pdldef{x}{\mit{block\_body}}}
    \\
    \mit{block\_body} & ::= &\ 
    \pdlmodel{\mit{model}}{\mit{prompt}}
    \\ &&\mid
    \pdlcode{\mit{prompt}}
    \\ &&\mid
    \pdlapi{\mit{url}}{\mit{api}}{\mit{prompt}}
    \\ &&\mid
    \pdlget{\mit{x}}
    \\ &&\mid
    \pdlvalue{\mit{json}}
    \\ &&\mid
    \pdlvaluep{\mit{json}}{\mit{string}}
    \\ &&\mid
    \pdlsequence{\mit{prompts}}
    \\ &&\mid
    \pdlif{\mit{prompts}}{\mit{condition}}
    \\ &&\mid
    \pdlrepeats{\mit{prompts}}{\mit{n}}
    \\ &&\mid
    \pdlrepeatsuntil{\mit{prompts}}{\mit{condition}}
    \\ &&\mid
    \pdlinput{\mit{msg}}
    \\ &&\mid
    \pdlfunction{\mit{json\_schema}}{\mit{block\_body}}
    \\ &&\mid
    \pdlcall{f}{\mit{json}}
    \\
    \mit{condition} & ::= &\ \dots

\end{array}
$$

The semantics of a prompt~$p$ is defined by the reductions $\pdlsemp{S}{p}{S'}{v}{s}$ which evaluates~$p$ in the environment~$S$ to return the updated environment~$S'$, the value~$v$, and the string~$s$.

The semantics of a block body~$b$ is defined by the reductions $\pdlsembb{S}{b}{S'}{v}{s}$ which evaluates~$b$ in the environment~$S$ to return the updated environment~$S'$, the value~$v$, and the string~$s$.

\begin{mathpar}
% String
\inferrule%
{ \\
}
{\pdlsemp{S}{s}{S}{s}{s}}


% Block show = true
\inferrule%
{\pdlsembb{S}{b}{S'}{v}{s} \\
}
{\pdlsemp{S}{\pdlblock[\True]{x}{b}}{S'[x \leftarrow v]}{v}{s}}

% Block show = false
\inferrule%
{\pdlsembb{S}{b}{S'}{v}{s} \\
}
{\pdlsemp{S}{\pdlblock[\False]{x}{b}}{S'[x \leftarrow v]}{v}{\jsstr{}}}

% Defs empty
\inferrule%
{\pdlsemp{S}{\mit{block}}{S'}{v}{s}
}
{\pdlsemp{S}{\pdlblockdefs{\jsobj{}}{\mit{block}}}{S}{v}{s}}

% Defs
\inferrule%
{\pdlsembb{S}{b_x}{S'}{v_x}{s_x} \\
 \pdlsemp{S[x \leftarrow v_x]}{\pdlblockdefs{\jsobj{\mit{defs}}}{\mit{block}}}{S'}{v}{s}
}
{\pdlsemp{S}{\pdlblockdefs{\jsobj{\pdldef{x}{b_x}\mtt{,} \mit{defs}}}{\mit{block}}}{S}{v}{s}}

\end{mathpar}

\begin{mathpar}
% Sequence empty
\inferrule%
{
}
{\pdlsemp{S}{\jsarr{}}
          {S}{\jsnull}{\jsstr{}}}

% Sequence one
\inferrule%
{\pdlsemp{S}{p}{S'}{v}{s}
}
{\pdlsemp{S}{\jsarr{p}}{S'}{v}{s}}

% Sequence
\inferrule%
{\pdlsemp{S}{p_1}{S_1}{v_1}{s_1} \\
 \pdlsemp{S_1[\mit{context} \leftarrow S(\mit{context}) + s_1]}{\mit{prompts}}{S'}{v}{s}
}
{\pdlsemp{S}{\jsarr{p_1, \mit{prompts}}}
          {S'[\mit{context} \leftarrow S(\mit{context})]}{v}{s_1 + s}}

\end{mathpar}

\begin{mathpar}
% Model
\inferrule%
{\pdlsemp{S}{p}{S'}{\_}{s} \textsc{~~OR~~} \pdlsemp{S[\mit{context}\leftarrow \jsstr{}]}{p}{S'}{\_}{s}\\
  m(s) = v
}
{\pdlsembb{S}{\pdlmodel{m}{p}}{S}{v}{\pdlstr{v}}}

% Code
\inferrule%
{\pdlsemp{S}{p}{S'}{\_}{s} \textsc{~~OR~~} \pdlsemp{S[\mit{context}\leftarrow \jsstr{}]}{p}{S'}{\_}{s}\\
 s \Downarrow v
}
{\pdlsembb{S}{\pdlcode{p}}{S}{v}{\pdlstr{v}}}

% API
\inferrule%
{\pdlsemp{S}{p}{S'}{\_}{s} \textsc{~~OR~~} \pdlsemp{S[\mit{context}\leftarrow \jsstr{}]}{p}{S'}{\_}{s}\\
  \mit{url}/\mit{api}(s) = v
}
{\pdlsembb{S}{\pdlapi{\mit{url}}{\mit{api}}{p}}{S}{v}{\pdlstr{v}}}

% Get
\inferrule%
{S(x) = v
}
{\pdlsembb{S}{\pdlget{x}}{S}{v}{\pdlstr{v}}}

% Value
\inferrule%
{
}
{\pdlsembb{S}{\pdlvalue{v}}{S}{v}{\pdlstr{v}}}

% Valuep
\inferrule%
{
}
{\pdlsembb{S}{\pdlvaluep{v}{s}}{S}{v}{s}}


% Sequence one
\inferrule%
{\pdlsemp{S}{\mit{prompts}}{S'}{v}{s}
}
{\pdlsembb{S}{\pdlsequence{\mit{prompts}}}{S'}{v}{s}}


% If true
\inferrule%
{\pdlsemc{S}{c}{\True} \\
 \pdlsemp{S}{p}{S'}{v}{s}
}
{\pdlsembb{S}{\pdlif{p}{c}}{S'}{v}{s}}

% If false
\inferrule%
{\pdlsemc{S}{c}{\False}}
{\pdlsembb{S}{\pdlif{p}{c}}{S'}{\jsnull}{\jsstr{}}}

% Repeats true
\inferrule%
{\pdlsemp{S}{p}{S_1}{v_1}{s_1}\\
 n > 0 \\
 \pdlsembb{S_1[\mit{context} \leftarrow S(\mit{context})+s_1]}{\pdlrepeats{p}{n-1}}{S'}{v}{s}
}
{\pdlsembb{S}{\pdlrepeats{p}{n}}{S'}{v}{s}}

% Repeats false
\inferrule%
{\pdlsemp{S}{p}{S'}{v}{s}\\
 n \le 0
}
{\pdlsembb{S}{\pdlrepeats{p}{n}}{S'}{v}{s}}

% Repeats_until true
\inferrule%
{\pdlsemp{S}{p}{S_1}{v_1}{s_1}\\
 \pdlsemc{S_1}{c}{\True} \\
 \pdlsembb{S_1[\mit{context} \leftarrow S(\mit{context})+s_1]}{\pdlrepeatsuntil{p}{c}}{S'}{v}{s}
}
{\pdlsembb{S}{\pdlrepeatsuntil{p}{c}}{S'}{v}{s}}

% Repeats_until false
\inferrule%
{\pdlsemp{S}{p}{S'}{v}{s}\\
 \pdlsemc{S'}{c}{\False}
}
{\pdlsembb{S}{\pdlrepeatsuntil{p}{c}}{S'}{v}{s}}

% Function
\inferrule%
{
}
{\pdlsembb{S}{\pdlfunction{x}{b}}{S}{\pdlclosure{x}{b}{S}}{\jsstr{}}}

% Call
\inferrule%
{S(f) = \pdlclosure{x}{b}{S'}\\
 \pdlsembb{S'[\mit{context} \leftarrow S(\mit{context})] + \mit{args}}{b}{S''}{v}{s}}
{\pdlsembb{S}{\pdlcall{f}{\mit{args}}}{S}{v}{s}}

\end{mathpar}

\end{document}